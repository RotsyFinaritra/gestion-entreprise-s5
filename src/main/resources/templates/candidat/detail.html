<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html}">
<head>
    <title>Détail Candidat</title>
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-marker {
            position: absolute;
            left: -35px;
            top: 0;
            width: 20px;
            height: 20px;
            background-color: #6c757d;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .timeline-marker.current {
            background-color: #007bff;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.25);
        }
        
        .timeline-marker i {
            color: white;
            font-size: 8px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 20px;
            bottom: 0;
            width: 2px;
            background-color: #dee2e6;
        }
        
        .timeline-content {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .timeline-current .timeline-content {
            border-left-color: #007bff;
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        .card:hover {
            transform: translateY(-2px);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div th:fragment="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">
                                <i class="fas fa-user me-2"></i>
                                Détail du candidat
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <!-- Photo du candidat -->
                                    <div class="text-center mb-4">
                                        <div class="candidate-photo-container">
                                            <img th:if="${candidat.image != null and candidat.image != ''}" 
                                                 th:src="${candidat.image}" 
                                                 alt="Photo de profil"
                                                 class="img-fluid rounded-circle candidate-photo"
                                                 style="width: 200px; height: 200px; object-fit: cover; border: 4px solid #dee2e6;">
                                            <div th:unless="${candidat.image != null and candidat.image != ''}" 
                                                 class="no-photo-placeholder rounded-circle d-flex align-items-center justify-content-center"
                                                 style="width: 200px; height: 200px; background-color: #f8f9fa; border: 4px solid #dee2e6; margin: 0 auto;">
                                                <i class="fas fa-user" style="font-size: 4rem; color: #6c757d;"></i>
                                            </div>
                                        </div>
                                        <h4 th:text="${candidat.prenom + ' ' + candidat.nom}" class="mt-3 mb-1">Nom Prénom</h4>
                                        <p class="text-muted" th:text="${candidat.email}">email@example.com</p>
                                    </div>
                                </div>
                                
                                <div class="col-md-8">
                                    <!-- Informations personnelles -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h5><i class="fas fa-info-circle me-2"></i>Informations personnelles</h5>
                                            <table class="table table-borderless">
                                                <tr>
                                                    <td class="fw-bold">Téléphone:</td>
                                                    <td th:text="${candidat.tel}">+261 34 xx xx xx</td>
                                                </tr>
                                                <tr th:if="${candidat.adresse != null and candidat.adresse != ''}">
                                                    <td class="fw-bold">Adresse:</td>
                                                    <td th:text="${candidat.adresse}">Adresse</td>
                                                </tr>
                                                <tr th:if="${candidat.dateNaissance != null}">
                                                    <td class="fw-bold">Date de naissance:</td>
                                                    <td th:text="${#temporals.format(candidat.dateNaissance, 'dd/MM/yyyy')}">01/01/1990</td>
                                                </tr>
                                                <tr th:if="${candidat.genre != null}">
                                                    <td class="fw-bold">Genre:</td>
                                                    <td th:text="${candidat.genre.nom}">Genre</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Date de candidature:</td>
                                                    <td th:text="${#temporals.format(candidat.dateDepot, 'dd/MM/yyyy')}">01/01/2025</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Offre -->
                                    <div class="row mb-4" th:if="${candidat.offre != null}">
                                        <div class="col-12">
                                            <h5><i class="fas fa-briefcase me-2"></i>Offre postulée</h5>
                                            <div class="alert alert-info">
                                                <h6 th:text="${candidat.offre.poste?.nom}">Poste</h6>
                                                <p class="mb-0" th:if="${candidat.offre.local != null}">
                                                    <i class="fas fa-map-marker-alt me-1"></i>
                                                    <span th:text="${candidat.offre.local.nom}">Localisation</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
            <!-- Statut actuel -->
            <div class="row mb-4" th:if="${#lists.size(candidat.statusCandidats) > 0}">
                <div class="col-12">
                    <h5><i class="fas fa-clipboard-check me-2"></i>Statut de candidature</h5>
                    <div class="timeline">
                        <div th:each="sc, iterStat : ${candidat.statusCandidats}" 
                             class="timeline-item" 
                             th:classappend="${iterStat.first} ? 'timeline-current' : ''">
                            <div class="timeline-marker" th:classappend="${iterStat.first} ? 'current' : ''">
                                <i class="fas fa-circle"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold" th:text="${sc.status.nom}">Statut</span>
                                    <small class="text-muted" th:text="${#temporals.format(sc.dateModification, 'dd/MM/yyyy')}">Date</small>
                                </div>
                                <span th:if="${iterStat.first}" class="badge bg-primary">Statut actuel</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Formations -->
            <div class="row mb-4">
                <div class="col-12">
                    <h5><i class="fas fa-graduation-cap me-2"></i>Formations</h5>
                    <div th:if="${#lists.size(candidat.formationCandidats) > 0}">
                        <div class="row">
                            <div th:each="fc : ${candidat.formationCandidats}" class="col-md-6 col-lg-4 mb-3">
                                <div class="card border-primary h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-graduation-cap fa-2x text-primary mb-2"></i>
                                        <h6 class="card-title" th:text="${fc.formation.nom}">Formation</h6>
                                        <span class="badge bg-primary">Niveau académique</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:if="${#lists.isEmpty(candidat.formationCandidats)}" class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>Aucune formation renseignée
                    </div>
                </div>
            </div>
            
            <!-- Compétences -->
            <div class="row mb-4">
                <div class="col-12">
                    <h5><i class="fas fa-star me-2"></i>Compétences techniques</h5>
                    <div th:if="${#lists.size(candidat.candidatCompetances) > 0}">
                        <div class="row">
                            <div th:each="cc : ${candidat.candidatCompetances}" class="col-md-6 col-lg-4 mb-3">
                                <div class="card border-success h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-code fa-2x text-success mb-2"></i>
                                        <h6 class="card-title" th:text="${cc.competance.nom}">Compétence</h6>
                                        <span class="badge bg-success">Compétence technique</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:if="${#lists.isEmpty(candidat.candidatCompetances)}" class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>Aucune compétence renseignée
                    </div>
                </div>
            </div>
            
            <!-- Profil professionnel (si disponible) -->
            <div class="row mb-4" th:if="${candidat.cv != null or candidat.lettreMotivation != null}">
                <div class="col-12">
                    <h5><i class="fas fa-user-tie me-2"></i>Profil professionnel</h5>
                    <div class="row">
                        <div class="col-md-6" th:if="${candidat.cv != null}">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-pdf fa-3x text-info mb-3"></i>
                                    <h6>Curriculum Vitae</h6>
                                    <a th:href="${candidat.cv}" class="btn btn-info btn-sm" target="_blank">
                                        <i class="fas fa-download me-1"></i>Télécharger CV
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6" th:if="${candidat.lettreMotivation != null}">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-alt fa-3x text-warning mb-3"></i>
                                    <h6>Lettre de motivation</h6>
                                    <a th:href="${candidat.lettreMotivation}" class="btn btn-warning btn-sm" target="_blank">
                                        <i class="fas fa-download me-1"></i>Télécharger LM
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Résultats des tests (si disponibles) -->
            <div class="row mb-4" th:if="${candidat.reponseCandidats != null and #lists.size(candidat.reponseCandidats) > 0}">
                <div class="col-12">
                    <h5><i class="fas fa-clipboard-list me-2"></i>Résultats des tests</h5>
                    <div class="alert alert-success">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-check-circle me-1"></i>Test technique</h6>
                                <p class="mb-0">
                                    Nombre de réponses : <span th:text="${#lists.size(candidat.reponseCandidats)}" class="fw-bold">0</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-clock me-1"></i>Statut</h6>
                                <p class="mb-0">Test complété</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Actions administratives -->
            <div class="row mb-4">
                <div class="col-12">
                    <h5><i class="fas fa-cogs me-2"></i>Actions rapides</h5>
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-primary w-100" onclick="inviterTest1()">
                                <i class="fas fa-paper-plane me-2"></i>Inviter au Test 1
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-success w-100" onclick="inviterTest2()">
                                <i class="fas fa-clipboard-check me-2"></i>Inviter au Test 2
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-info w-100" onclick="changerStatut()">
                                <i class="fas fa-exchange-alt me-2"></i>Changer statut
                            </button>
                        </div>
                    </div>
                </div>
            </div>
                            <!-- Actions -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="btn-group" role="group">
                                        <a th:href="@{/candidats}" class="btn btn-secondary">
                                            <i class="fas fa-arrow-left me-2"></i>Retour à la liste
                                        </a>
                                        <a th:href="@{/candidats/edit/{id}(id=${candidat.idCandidat})}" class="btn btn-primary">
                                            <i class="fas fa-edit me-2"></i>Modifier
                                        </a>
                                        <a th:href="@{/candidats/delete/{id}(id=${candidat.idCandidat})}" 
                                           class="btn btn-danger"
                                           onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce candidat ?')">
                                            <i class="fas fa-trash me-2"></i>Supprimer
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        var candidatId = /*[[${candidat.idCandidat}]]*/ 0;
        function inviterTest1() {
            if (confirm('Inviter ce candidat au Test 1 ?')) {
                fetch('/test1/inviter/' + candidatId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message || 'Invitation envoyée !');
                    location.reload();
                })
                .catch(error => {
                    alert('Erreur lors de l\'envoi de l\'invitation');
                });
            }
        }
        
        function inviterTest2() {
            if (confirm('Inviter ce candidat au Test 2 ?')) {
                fetch('/test2/inviter/' + candidatId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message || 'Invitation envoyée !');
                    location.reload();
                })
                .catch(error => {
                    alert('Erreur lors de l\'envoi de l\'invitation');
                });
            }
        }
        
        function changerStatut() {
            const nouveauStatut = prompt('Nouveau statut:', '');
            if (nouveauStatut) {
                fetch('/candidats/statut/' + candidatId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ statut: nouveauStatut })
                })
                .then(response => response.json())
                .then(data => {
                    alert('Statut mis à jour !');
                    location.reload();
                })
                .catch(error => {
                    alert('Erreur lors du changement de statut');
                });
            }
        }
        /*]]>*/
    </script>
</body>
</html>
